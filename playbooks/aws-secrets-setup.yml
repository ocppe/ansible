---
# Playbook: aws-secrets-setup.yml
# Creates AWS Secrets Manager secrets and IAM resources for External Secrets Operator
#
# Usage:
#   ansible-playbook playbooks/aws-secrets-setup.yml \
#     -e quay_username=ocppe+robot \
#     -e quay_password=ROBOT_TOKEN \
#     -e git_username=YOUR_GITHUB_USERNAME \
#     -e git_password=YOUR_GITHUB_PAT

- name: Setup AWS Secrets Manager and IAM for External Secrets Operator
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    secrets_prefix: "ocppe"
    iam_policy_name: "ExternalSecretsPolicy"
    iam_role_name: "ExternalSecretsRole"
    service_account_namespace: "external-secrets-operator"
    service_account_name: "external-secrets-sa"

  tasks:
    # ==================== Generate Secrets ====================
    - name: Generate backend secret for Developer Hub
      ansible.builtin.set_fact:
        backend_secret: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') | b64encode }}"

    - name: Generate OAuth client secret for Developer Hub
      ansible.builtin.set_fact:
        oauth_client_secret: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') | b64encode }}"

    - name: Generate GitHub webhook secret
      ansible.builtin.set_fact:
        github_webhook_secret: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=40') | lower }}"

    # ==================== Create/Update Secrets ====================
    - name: Check if Developer Hub secret exists
      ansible.builtin.command:
        cmd: >
          aws secretsmanager describe-secret
          --secret-id {{ secrets_prefix }}/developer-hub
          --region {{ aws_region }}
      register: devhub_secret_check
      failed_when: false
      changed_when: false

    - name: Create Developer Hub secret
      ansible.builtin.command:
        cmd: >
          aws secretsmanager create-secret
          --name {{ secrets_prefix }}/developer-hub
          --secret-string '{"backend-secret":"{{ backend_secret }}","oauth-client-secret":"{{ oauth_client_secret }}"}'
          --region {{ aws_region }}
      when: devhub_secret_check.rc != 0
      register: devhub_secret_created

    - name: Update Developer Hub secret if exists
      ansible.builtin.command:
        cmd: >
          aws secretsmanager put-secret-value
          --secret-id {{ secrets_prefix }}/developer-hub
          --secret-string '{"backend-secret":"{{ backend_secret }}","oauth-client-secret":"{{ oauth_client_secret }}"}'
          --region {{ aws_region }}
      when: devhub_secret_check.rc == 0

    - name: Check if CI Pipelines secret exists
      ansible.builtin.command:
        cmd: >
          aws secretsmanager describe-secret
          --secret-id {{ secrets_prefix }}/ci-pipelines
          --region {{ aws_region }}
      register: pipelines_secret_check
      failed_when: false
      changed_when: false

    - name: Create CI Pipelines secret
      ansible.builtin.command:
        cmd: >
          aws secretsmanager create-secret
          --name {{ secrets_prefix }}/ci-pipelines
          --secret-string '{"github-webhook-secret":"{{ github_webhook_secret }}","quay-username":"{{ quay_username }}","quay-password":"{{ quay_password }}","git-username":"{{ git_username }}","git-password":"{{ git_password }}"}'
          --region {{ aws_region }}
      when: pipelines_secret_check.rc != 0

    - name: Update CI Pipelines secret if exists
      ansible.builtin.command:
        cmd: >
          aws secretsmanager put-secret-value
          --secret-id {{ secrets_prefix }}/ci-pipelines
          --secret-string '{"github-webhook-secret":"{{ github_webhook_secret }}","quay-username":"{{ quay_username }}","quay-password":"{{ quay_password }}","git-username":"{{ git_username }}","git-password":"{{ git_password }}"}'
          --region {{ aws_region }}
      when: pipelines_secret_check.rc == 0

    # ==================== Create IAM Policy ====================
    - name: Get AWS account ID
      ansible.builtin.command:
        cmd: aws sts get-caller-identity --query Account --output text
      register: aws_account_id_result
      changed_when: false

    - name: Set AWS account ID fact
      ansible.builtin.set_fact:
        aws_account_id: "{{ aws_account_id_result.stdout }}"

    - name: Check if IAM policy exists
      ansible.builtin.command:
        cmd: >
          aws iam get-policy
          --policy-arn arn:aws:iam::{{ aws_account_id }}:policy/{{ iam_policy_name }}
      register: policy_check
      failed_when: false
      changed_when: false

    - name: Create IAM policy document
      ansible.builtin.copy:
        content: |
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "secretsmanager:GetSecretValue",
                  "secretsmanager:DescribeSecret"
                ],
                "Resource": "arn:aws:secretsmanager:{{ aws_region }}:{{ aws_account_id }}:secret:{{ secrets_prefix }}/*"
              }
            ]
          }
        dest: /tmp/external-secrets-policy.json
        mode: '0644'
      when: policy_check.rc != 0

    - name: Create IAM policy
      ansible.builtin.command:
        cmd: >
          aws iam create-policy
          --policy-name {{ iam_policy_name }}
          --policy-document file:///tmp/external-secrets-policy.json
      when: policy_check.rc != 0

    # ==================== Create IAM Role ====================
    - name: Get OIDC provider from cluster
      ansible.builtin.command:
        cmd: oc get authentication cluster -o jsonpath='{.spec.serviceAccountIssuer}'
      register: oidc_issuer_result
      changed_when: false

    - name: Set OIDC provider fact
      ansible.builtin.set_fact:
        oidc_provider: "{{ oidc_issuer_result.stdout | regex_replace('^https://', '') }}"

    - name: Check if IAM role exists
      ansible.builtin.command:
        cmd: aws iam get-role --role-name {{ iam_role_name }}
      register: role_check
      failed_when: false
      changed_when: false

    - name: Create trust policy document
      ansible.builtin.copy:
        content: |
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Federated": "arn:aws:iam::{{ aws_account_id }}:oidc-provider/{{ oidc_provider }}"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "{{ oidc_provider }}:sub": "system:serviceaccount:{{ service_account_namespace }}:{{ service_account_name }}"
                  }
                }
              }
            ]
          }
        dest: /tmp/trust-policy.json
        mode: '0644'
      when: role_check.rc != 0

    - name: Create IAM role
      ansible.builtin.command:
        cmd: >
          aws iam create-role
          --role-name {{ iam_role_name }}
          --assume-role-policy-document file:///tmp/trust-policy.json
      when: role_check.rc != 0

    - name: Attach policy to role
      ansible.builtin.command:
        cmd: >
          aws iam attach-role-policy
          --role-name {{ iam_role_name }}
          --policy-arn arn:aws:iam::{{ aws_account_id }}:policy/{{ iam_policy_name }}
      when: role_check.rc != 0

    # ==================== Annotate Service Account ====================
    - name: Check if service account exists
      ansible.builtin.command:
        cmd: oc get sa {{ service_account_name }} -n {{ service_account_namespace }}
      register: sa_check
      failed_when: false
      changed_when: false

    - name: Annotate service account with IAM role
      ansible.builtin.command:
        cmd: >
          oc annotate serviceaccount {{ service_account_name }}
          -n {{ service_account_namespace }}
          eks.amazonaws.com/role-arn=arn:aws:iam::{{ aws_account_id }}:role/{{ iam_role_name }}
          --overwrite
      when: sa_check.rc == 0

    # ==================== Output Summary ====================
    - name: Display generated secrets
      ansible.builtin.debug:
        msg: |
          
          ============================================================
          AWS Secrets Manager Setup Complete
          ============================================================
          
          Secrets created in AWS Secrets Manager:
            - {{ secrets_prefix }}/developer-hub
            - {{ secrets_prefix }}/ci-pipelines
          
          IAM Resources:
            - Policy: {{ iam_policy_name }}
            - Role: {{ iam_role_name }}
          
          IMPORTANT - Save these values for configuration:
          
          OAuth Client Secret (for Developer Hub kustomization):
            {{ oauth_client_secret }}
          
          GitHub Webhook Secret (for GitHub webhook configuration):
            {{ github_webhook_secret }}
          
          ============================================================

    - name: Save secrets to local file
      ansible.builtin.copy:
        content: |
          # Generated secrets - DO NOT COMMIT THIS FILE
          # Generated at: {{ ansible_date_time.iso8601 | default('unknown') }}
          
          OAUTH_CLIENT_SECRET={{ oauth_client_secret }}
          GITHUB_WEBHOOK_SECRET={{ github_webhook_secret }}
        dest: "{{ playbook_dir }}/../.secrets.env"
        mode: '0600'

    - name: Remind about .secrets.env
      ansible.builtin.debug:
        msg: "Secrets saved to ansible/.secrets.env - DO NOT COMMIT THIS FILE"
